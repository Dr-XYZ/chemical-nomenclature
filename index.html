<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>化學英文命名練習</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
body { margin:0; font-family:system-ui, Arial, sans-serif; background:#f9fafb; color:#222; }
.app { display:flex; flex-direction:column; height:100vh; width:100vw; overflow:hidden; }
.progress-bar { height:6px; background:#ddd; flex-shrink:0; }
.progress-fill { height:100%; background:#4a90e2; width:0%; transition:width 0.3s; }
.main { flex:1; display:flex; flex-direction:column; justify-content:space-between; padding:0.8rem; }
#question {
  font-size:1.5rem;
  text-align:center;
  margin:0.5rem 0;
  flex:1;
  display:flex;
  justify-content:center;
  align-items:center;
  overflow-y: auto;
  padding: 0.5rem;
}
.options {
  display:flex;
  flex-direction:column;
  width:100%;
  flex-shrink:0;
}
button.option {
  flex:1;
  padding:0.8rem;
  font-size:1.1rem;
  border:none;
  border-radius:8px;
  background:#f0f0f0;
  transition:background 0.2s, transform 0.15s;
  text-align:center;
  cursor:pointer;
  margin-bottom: 0.6rem;
  line-height: 1.3;
}
button.option:last-child { margin-bottom: 0; }
button.option:active { transform:scale(0.98); }
.correct { background:#a6e3a1 !important; }
.wrong { background:#f6a6a6 !important; }
.footer {
  padding-top:0.5rem;
  border-top:1px solid #eee;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:1rem;
  flex-shrink:0;
}
button.control {
  padding:0.6rem 1rem;
  font-size:1rem;
  border:none;
  border-radius:6px;
  background:#4a90e2;
  color:white;
  cursor:pointer;
  white-space: nowrap;
}
.end-screen { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:1rem; flex:1; text-align:center; }
.end-screen h2 { font-size:1.4rem; }
.hidden { display:none !important; }

/* 針對 MathJax 渲染的內容進行調整，防止溢出 */
.MathJax {
    overflow-x: auto;
    max-width: 100%;
}
</style>
<script>
// MathJax 配置
window.MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']],
    displayMath: [['$$', '$$'], ['\\[', '\\]']],
    processEscapes: true,
    tags: 'ams'
  },
  svg: { fontCache: 'global' }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
<div class="app">
  <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>

  <div class="main" id="quiz">
    <div id="question">載入題目中...</div>
    <div class="options" id="options"></div>
    <div class="footer">
      <span id="progress">0/0</span>
      <span id="score">分數: 0/0</span>
      <button class="control" onclick="showHint()">提示</button>
      <button class="control hidden" id="nextQuestionBtn">下一題</button>
    </div>
  </div>

  <div class="main hidden" id="endScreen">
    <div class="end-screen">
      <h2 id="resultText"></h2>
      <button class="control" id="retryWrong">重練錯題</button>
      <button class="control" onclick="restart()">回到首頁</button>
    </div>
  </div>
</div>

<script>
let allData=[], quizData=[], wrongQuestions=[];
let current=0, correct=0, answered=0, hintUsed=false;
const nextQuestionBtn = document.getElementById("nextQuestionBtn");

// 把文字包成 \text{...}，保留空格
function latexText(str){
  if(!str) return "";
  // 先處理特殊字元，避免衝突
  str = str.replace(/([{}_$&#%])/g, '\\$1');
  return `\\text{${str}}`;
}

// CSV 解析
function parseCSV(text){
  const lines=text.trim().split("\n").map(r=>r.replace(/^\uFEFF/, ''));
  const data=[];
  for(let i=1;i<lines.length;i++){
    const cols=lines[i].split(",").map(c=>c.trim());
    if(cols.length<7){ console.warn("欄位不足:", lines[i]); continue; }
    data.push({
      category: cols[0]||"unknown",
      question: cols[1]||"無題目",
      answer: cols[2]||"無答案",
      options: cols.slice(3,7).map(o=>o||"無選項")
    });
  }
  return data;
}

// 隨機排序
function shuffleArray(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
}

// 讀 CSV
async function loadCSV(){
  try{
    const response=await fetch("data/questions.csv");
    if(!response.ok) throw new Error("HTTP錯誤:"+response.status);
    const text=await response.text();
    allData=parseCSV(text);
    if(allData.length===0) throw new Error("題庫為空");
    shuffleArray(allData);
    startQuiz();
  }catch(e){
    console.error(e);
    document.getElementById("question").innerText="題庫讀取失敗";
  }
}

// 開始練習
function startQuiz(useWrong=false){
  quizData=useWrong ? [...wrongQuestions] : [...allData];
  shuffleArray(quizData);
  current=0; correct=0; answered=0; wrongQuestions=[];
  document.getElementById("quiz").classList.remove("hidden");
  document.getElementById("endScreen").classList.add("hidden");
  nextQuestionBtn.classList.add("hidden");
  showQuestion();
}

// 顯示題目
function showQuestion(){
  if(current >= quizData.length){ showEndScreen(); return; }
  const q = quizData[current];

  const questionDiv = document.getElementById("question");
  questionDiv.innerHTML = `$${latexText(q.question)}$`;

  const optionsDiv = document.getElementById("options");
  optionsDiv.innerHTML = "";
  const opts = [...q.options];
  shuffleArray(opts);
  opts.forEach(opt => {
    const btn = document.createElement("button");
    btn.className = "option";
    btn.dataset.value = opt;
    btn.innerHTML = `$${latexText(opt)}$`;
    btn.onclick = () => checkAnswer(opt);
    optionsDiv.appendChild(btn);
  });

  hintUsed=false;
  nextQuestionBtn.classList.add("hidden");
  updateProgress();
  MathJax.typesetPromise([questionDiv, optionsDiv]);
}

// 檢查答案
function checkAnswer(selected){
  const q = quizData[current];
  const buttons = document.querySelectorAll(".option");
  answered++;

  buttons.forEach(b=>{
    if(b.dataset.value === q.answer) b.classList.add("correct");
    else if(b.dataset.value === selected && selected !== q.answer) b.classList.add("wrong");
    b.disabled = true;
  });

  if(selected===q.answer) correct++;
  else wrongQuestions.push(q);

  nextQuestionBtn.classList.remove("hidden");
  nextQuestionBtn.onclick = () => { current++; showQuestion(); };
  updateProgress();
  MathJax.typesetPromise([document.getElementById("options")]);
}

// 更新進度
function updateProgress(){
  document.getElementById("progress").innerText = `${current+1}/${quizData.length}`;
  document.getElementById("score").innerText = `分數: ${correct}/${answered}`;
  document.getElementById("progressFill").style.width = `${((current+1)/quizData.length)*100}%`;
}

// 顯示提示
function showHint(){
  const q = quizData[current];
  if(!q || hintUsed) return;
  hintUsed=true;
  const hint=q.answer.slice(0,2)+"_".repeat(q.answer.length-2);
  const questionDiv = document.getElementById("question");
  questionDiv.innerHTML = `$${latexText(q.question)}$ → 提示：$${latexText(hint)}$`;
  MathJax.typesetPromise([questionDiv]);
}

// 結束畫面
function showEndScreen(){
  document.getElementById("quiz").classList.add("hidden");
  document.getElementById("endScreen").classList.remove("hidden");
  document.getElementById("resultText").innerText=`完成！正確率 ${(correct/quizData.length*100).toFixed(0)}%，已答題數 ${quizData.length}`;
  const retryBtn = document.getElementById("retryWrong");
  if(wrongQuestions.length>0){
    retryBtn.style.display="block";
    retryBtn.onclick=()=>startQuiz(true);
  }else retryBtn.style.display="none";
}

// 回首頁
function restart(){ location.reload(); }

loadCSV();
</script>
</body>
</html>